(()=>{var J0=($,x)=>{let q=window;for(let Q=0;Q<$.length-1;Q++){if(typeof q[$[Q]]!=="object"||!Array.isArray(q[$[Q]]))q[$[Q]]={};q=q[$[Q]]}q[$[$.length-1]]=x};var C6="CONNECTED",P6="CONNECTING",c="DISCONNECTED",b6="DISCONNECTING",W0="PENDING_VERIFICATION";var A6="_X0",L6="_X1",N6="_X2",D6="_X3",K6="_X4",X0="_RC",z0="_RJ";var h6="_SU",g6="_SS",j0="_UJ",F0="_UK",Y0="_UL",m6="_UV";var T6="ABCDEFGHKMNPQRSTUVWXYZ23456789",V0=($=24,x="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789")=>{let q="";for(let Q=0;Q<$;Q++)q+=x.charAt(Math.floor(Math.random()*x.length));return q};var U=($)=>{let x=atob($);return Uint8Array.from(x,(q)=>q.charCodeAt(0)).buffer},B0=($)=>{let x=atob($),q=Uint8Array.from(x,(Q)=>Q.charCodeAt(0));return new TextDecoder().decode(q)},G0=($)=>{let x=new TextEncoder().encode($);if(x.length<65536)return btoa(String.fromCharCode(...x));let q="",Q=65536;for(let J=0;J<x.length;J+=Q){let Y=x.subarray(J,J+Q);q+=String.fromCharCode(...Y)}return btoa(q)},O=($)=>{let x=new Uint8Array($);if(x.length<65536)return btoa(String.fromCharCode(...x));let q="",Q=65536;for(let J=0;J<x.length;J+=Q){let Y=x.subarray(J,J+Q);q+=String.fromCharCode(...Y)}return btoa(q)};var R=()=>{let $=new Map;return{addListener:(x,q)=>{if(!$.has(x))$.set(x,q)},removeListener:(x)=>{$.delete(x)},dispatch:(x)=>{for(let[q,Q]of $.entries())if(q(x),Q&&Q.once)$.delete(q)}}};var w0=($,x)=>{let q=[];for(let Q in $){let J=$[Q];if(J!==null&&J!==void 0)q.push(Q+":"+x(String(J)))}return q.join("|")},L0=($,x)=>{let q={},Q=$.split("|");for(let J of Q){let Y=J.indexOf(":");if(Y>0){let r=J.substring(0,Y),M=J.substring(Y+1);q[r]=x(M)}}return q};var M0=($,x)=>{let q=Date.now();if(!$)return{delay:0,offset:0,adjusted:q};if(!x){let Y=$-q;return{delay:0,offset:Y,adjusted:q+Y}}let Q=q-x,J=($-x+($-q))/2;return{delay:Q,offset:J,adjusted:q-Q+J}};var J6="ECDH",R6="P-256",W6="raw",s="SHA-256",X6="spki",f="AES-GCM",f6=256,z6="RSA-OAEP",u="RSASSA-PKCS1-v1_5",k0="self.addEventListener('message',"+(()=>{Promise.all([crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["encrypt","decrypt"]),crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"])]).then(([$,x,q])=>{Promise.all([crypto.subtle.exportKey("spki",$.publicKey),crypto.subtle.exportKey("spki",x.publicKey)]).then(([Q,J])=>{self.postMessage({success:!0,myEncryptKeys:$,mySignKeys:x,myExchangeKeys:q,myPublicEncryptKey:Q,myPublicSignKey:J})}).catch((Q)=>{self.postMessage({success:!1,error:Q.message})})}).catch(($)=>{self.postMessage({success:!1,error:$.message})})}).toString()+")",H0="self.addEventListener('message',"+(()=>{crypto.subtle.generateKey({length:256,name:"AES-GCM"},!0,["encrypt","decrypt"]).then(($)=>{self.postMessage({success:!0,sharedKey:$})}).catch(($)=>{self.postMessage({success:!1,error:$.message})})}).toString()+")";var l6="S",U0="T",v6="E",I6="I",E6="U",S6="D",u6="V",y6="K",p6="P",_6="G";var M6=($={})=>{let{contentType:x="application/json",deserializeMessage:q=JSON.parse,serializeMessage:Q=JSON.stringify,createRoomEndpoint:J="/create-room",joinRoomEndpoint:Y="/join-room",httpUrl:r="http://localhost:3000",wsUrl:M="http://localhost:3000",messageBufferMaxCount:a=50,messageBufferMaxDuration:t=60000}=$,b=c,B,h,y,d,g,Z,G,k,F,C,e,l,p,j6,I,m=[],T,n=new Map,x6=new Map,q6=new Map,F6=new Map,U6=new Map,_=()=>{if(!h&&!y)y=new Promise((W,j)=>{let w=new Worker(URL.createObjectURL(new Blob([k0],{type:"text/javascript"})));w.addEventListener("message",(X)=>{if(X.data.success)d=X.data.myEncryptKeys,F=X.data.mySignKeys,g=X.data.myExchangeKeys,G=X.data.myPublicEncryptKey,k=X.data.myPublicSignKey,h=!0,y=null,W();else{let H=Error(X.data.error);L.dispatch({error:H}),j(H)}w.terminate()}),w.addEventListener("error",(X)=>{L.dispatch({error:X}),j(X),w.terminate()}),w.postMessage({type:"USER_KEYS"})});return y};_();let L=R(),n6=R(),o6=R(),i6=R(),s6=R(),r6=R(),Y6=R(),a6=R(),t6=R(),E=(W)=>{if(b!==W)b=W,t6.dispatch({state:W})},e6=async(W)=>{let j=n.get(W);if(!j)return;F6.set(W,Array.from(new Uint8Array(await crypto.subtle.digest(s,new TextEncoder().encode(j6+O(await crypto.subtle.exportKey("raw",j))))))),a6.dispatch({userId:W,code:O6(W)})},o=()=>{if(b===c||b===b6)return;if(E(b6),T)T.close();B=h=y=Z=d=g=G=k=F=C=e=l=p=I=m=T=null,n.clear(),x6.clear(),q6.clear(),F6.clear(),U6.clear(),_(),E(c)},V6=(W)=>B6({type:F0,userId:W}),x0=(W,j=null)=>{if(!j&&b&&b!==c)return;E(P6),j6=W;let w=new URL(M+Y);if(w.searchParams.append("code",j6),j)w.searchParams.append("creator",j);T=new WebSocket(w.toString()),T.addEventListener("close",(X)=>{i6.dispatch({event:X}),o()}),T.addEventListener("error",(X)=>{L.dispatch({event:X}),o()}),T.addEventListener("message",async(X)=>{q0(L0(X.data,B0),X.data)})},q0=async(W,j,w=!1)=>{let{[l6]:X,[U0]:H,[I6]:P,[v6]:N,[S6]:D,[u6]:$6,[y6]:$0,[p6]:Q0,[_6]:Z0,[E6]:Q6}=W,z,Z6,G6,i;if(X)G6=X;else if(D)G6=D;else G6=j;if(N){if(!I||!w&&m.length>0){if(m.push({time:Date.now(),parts:W,raw:j}),m.length>a)m.shift();return}if(!P){L.dispatch(Error("Missing IV to decrypt message"));return}z=await crypto.subtle.decrypt({iv:U(P),name:f},I,U(N)),z=new TextDecoder().decode(z),i=!0}else if(Q0){if(!$0||!$6){L.dispatch({error:Error("Missing signature or IV to decrypt message.")});return}if(!h)await _();let V=U(Q0),K=q(new TextDecoder().decode(await crypto.subtle.decrypt({iv:U($6),name:f},await crypto.subtle.importKey("raw",await crypto.subtle.decrypt({name:z6},d.privateKey,U($0)),{name:f},!0,["encrypt","decrypt"]),V)));if(i=!0,K.type===L6)Z6=K;else if(Z0){let v=K.sender;if(!v){L.dispatch({error:Error("Message from unknown sender")});return}let w6=q6.get(v);if(!w6){L.dispatch({error:Error("No public key for "+v)});return}if(!await crypto.subtle.verify(u,w6,U(Z0),V)){L.dispatch({error:Error("Invalid signature from "+v)});return}Z6=K}else{L.dispatch({error:Error("Missing encryption signature")});return}}else z=G6;if(!Z6)try{Z6=q(z)}catch(V){L.dispatch({error:Error("Failed to parse message "+j)});return}switch(z=Z6,z.type){case z0:if(B=z.creatorId,Z=z.userId,o6.dispatch({creatorId:z.creatorId,roomCode:j6,userId:z.userId,users:z.users}),Z===B)E(C6);else{if(E(W0),!h)await _();let V=await crypto.subtle.exportKey(W6,g.publicKey);S({type:A6,publicData:typeof l==="function"?l():l,publicEncryptKey:O(G),publicExchangeKey:O(V),publicSignKey:O(k),signature:O(await crypto.subtle.sign(u,F.privateKey,V))},{allowUnencrypted:!0,receiver:B})}break;case A6:if(Q6===B&&Z===B){let V=z.sender;if(p&&!p({data:z.publicData,userId:V})){V6(V);return}x6.set(V,await crypto.subtle.importKey(X6,U(z.publicEncryptKey),{hash:s,name:z6},!0,["encrypt"]));let K=await crypto.subtle.importKey(X6,U(z.publicSignKey),{hash:s,name:u},!0,["verify"]),v=U(z.publicExchangeKey);if(!await crypto.subtle.verify(u,K,U(z.signature),v)){L.dispatch({error:Error("Invalid signature for exchange from "+V)});return}if(q6.set(V,K),!h)await _();n.set(V,await crypto.subtle.deriveKey({name:J6,public:await crypto.subtle.importKey(W6,v,{name:J6,namedCurve:R6},!0,[])},g.privateKey,{length:f6,name:f},!0,["encrypt","decrypt"]));let w6=await crypto.subtle.exportKey(W6,g.publicKey);S({type:L6,publicData:typeof l==="function"?l():l,publicEncryptKey:O(G),publicExchangeKey:O(w6),publicSignKey:O(k)},{receiver:V}),e6(V)}break;case L6:if(Q6===Z&&z.sender===B){if(p&&!p({data:z.publicData,userId:B})){o();return}let V=await crypto.subtle.importKey(X6,U(z.publicSignKey),{hash:s,name:u},!0,["verify"]);if(z.publicExchangeKey&&z.signature){if(!await crypto.subtle.verify(u,V,U(z.signature),U(z.publicExchangeKey))){L.dispatch({error:Error("Invalid signature for exchange from "+B)}),o();return}}if(q6.set(B,V),x6.set(B,await crypto.subtle.importKey(X6,U(z.publicEncryptKey),{hash:s,name:z6},!0,["encrypt"])),!h)await _();n.set(B,await crypto.subtle.deriveKey({name:J6,public:await crypto.subtle.importKey(W6,U(z.publicExchangeKey),{name:J6,namedCurve:R6},!0,[])},g.privateKey,{length:f6,name:f},!0,["encrypt","decrypt"])),e6(B)}break;case N6:if(Q6===Z&&z.sender===B){if(!i){L.dispatch({error:Error("Message was not encrypted")});return}if(e&&!e({data:z.privateData,userId:B})){o();return}S({type:D6,privateData:C},{receiver:B})}break;case D6:if(Q6===B&&Z===B){if(!i){L.dispatch({error:Error("Message was not encrypted")});return}let V=z.sender;if(!U6.get(V)){L.dispatch({error:Error("User not verified")}),V6(V);return}if(e&&!e({data:z.privateData,userId:V})){V6(V);return}S({type:K6,sharedKey:O(await crypto.subtle.exportKey("raw",I))},{receiver:V}),Y6.dispatch({userId:V}),B6({type:m6,userId:V})}break;case K6:if(Q6===Z&&z.sender===B){if(!i){L.dispatch({error:Error("Message was not encrypted")});return}if(I=await crypto.subtle.importKey("raw",U(z.sharedKey),{name:f},!0,["encrypt","decrypt"]),Y6.dispatch({userId:Z}),m.length>0){let V=Date.now();m=m.filter((K)=>V-K.time<t);while(m.length>0){let{parts:K,raw:v}=m.shift();q0(K,v,!0)}}E(C6)}break;case Y0:r6.dispatch({userId:z.userId}),n.delete(z.userId),x6.delete(z.userId),q6.delete(z.userId);break;case j0:s6.dispatch({userId:z.userId});break;case m6:Y6.dispatch({userId:z.userId});break;default:if(!i){L.dispatch({error:Error("Message was not encrypted")});return}n6.dispatch({data:z,time:M0(H,z?.senderTime)});break}},S=async(W,j={})=>{if(!T||T.readyState!==WebSocket.OPEN)return L.dispatch({error:Error("No open socket")}),!1;let w=Q({...W,sender:Z,senderTime:Date.now()}),X={},H=j.receiver;if(H){let P=x6.get(H);if(P){let N=await crypto.subtle.generateKey({name:f,length:256},!0,["encrypt","decrypt"]),D=crypto.getRandomValues(new Uint8Array(12)),$6=await crypto.subtle.encrypt({iv:D,name:f},N,new TextEncoder().encode(w));if(!h)await _();X[u6]=O(D),X[y6]=O(await crypto.subtle.encrypt({name:z6},P,await crypto.subtle.exportKey("raw",N))),X[p6]=O($6),X[_6]=O(await crypto.subtle.sign(u,F.privateKey,$6))}else if(!j.allowUnencrypted)return L.dispatch({error:Error("No public key for "+H)}),!1;else X[S6]=w;X[E6]=H}else if(j.server)X[l6]=w;else if(I){let P=crypto.getRandomValues(new Uint8Array(12));X[I6]=O(P),X[v6]=O(await crypto.subtle.encrypt({iv:P,name:f},I,new TextEncoder().encode(w)))}else return L.dispatch(Error("Trying to send without valid destination")),!1;return T.send(w0(X,G0)),!0},B6=(W)=>Z&&Z===B&&S(W,{server:!0}),P0=(W,j)=>j&&S(W,{receiver:j}),O6=(W,j=6)=>{if(!F6.has(W))return!1;let w=F6.get(W),X="";for(let H=0;H<j;H++){let P=w[H]%T6.length;X+=T6[P]}return X};return{onConnection:t6,onError:L,onMessage:n6,onRoomJoin:o6,onRoomLeave:i6,onUserJoin:s6,onUserLeave:r6,onUserVerified:Y6,onUserVerificationCode:a6,messageRoom:(W)=>S(W),messageServer:B6,messageUser:P0,closeRoom:()=>B6({type:X0}),createRoom:async(W={})=>{if(b&&b!==c)return;if(E(P6),W.publicData)l=W.publicData;if(W.verifyPublicData)p=W.verifyPublicData;try{await new Promise((H,P)=>{let N=new Worker(URL.createObjectURL(new Blob([H0],{type:"text/javascript"})));N.addEventListener("message",(D)=>{if(D.data.success)I=D.data.sharedKey,H();else P(Error(D.data.error));N.terminate()}),N.addEventListener("error",(D)=>{P(D),N.terminate()}),N.postMessage({type:"SHARED_KEY"})})}catch(H){E(c),L.dispatch({error:H});return}let j=new URL(r+J);if(W.limit)j.searchParams.append("limit",W.limit);let w=await fetch(j.toString(),{method:"GET",headers:{Accept:x}});if(!w.ok)throw Error("Failed to create room");let X=await w.text();return X=q(X),Z=X.userId,x0(X.roomCode,X.creatorSecret),X},joinRoom:(W,j={})=>{if(j.publicData)l=j.publicData;if(j.verifyPublicData)p=j.verifyPublicData;x0(W)},leaveRoom:o,kickUser:V6,getVerificationCode:O6,verifyUser:async(W,j)=>{if(Z!==B||!j)return!1;let w=O6(W,j.length);if(!w||!j||w!==j)return!1;if(U6.set(W,!0),!n.get(W))return!1;return S({type:N6,privateData:C},{receiver:W}),!0}}};var A=($)=>{if(typeof $==="object"){let x=Array.isArray($)?[]:{};for(let q in $)x[q]=A($[q]);return x}return $};var c6=($,x,q)=>{let Q=$;for(let J=0;J<x.length-1;J++){let Y=x[J];if(!(Y in Q))Q[Y]={};Q=Q[Y]}Q[x[x.length-1]]=A(q)},O0=($,x)=>{let q=$;for(let Q=0;Q<x.length-1;Q++)if(q=q[x[Q]],!q)return;if(Array.isArray(q))q.splice(parseInt(x[x.length-1]),1);else delete q[x[x.length-1]]},k6=($,x,q=[])=>{let Q=[];for(let J in $){let Y=[...q,J];if(!(J in x))Q.unshift({type:"delete",path:Y,old:A($[J])});else if(typeof $[J]==="object"&&typeof x[J]==="object")Q.unshift(...k6($[J],x[J],Y));else if($[J]!==x[J])Q.unshift({type:"set",path:Y,old:A($[J]),new:A(x[J])})}for(let J in x)if(!(J in $))Q.unshift({type:"set",path:[...q,J],new:A(x[J])});return Q},H6=($,x)=>{for(let q of x)if(q.type==="set")c6($,q.path,q.new);else if(q.type==="delete")O0($,q.path);return $},d6=($,x)=>{for(let q of x)if(q.type==="set")if(q.old===void 0)O0($,q.path);else c6($,q.path,q.old);else if(q.type==="delete")c6($,q.path,q.old);return $};var C0=($={},x={},q={})=>{let Q=M6($),{messageRoom:J}=Q,{windowPerUser:Y=16,synchronisationInterval:r=60000}=$,M=[],a,t=0,b=0,B=Y,h=(Z)=>{let G=V0(),k=Z.length>0?Z[0].identifier:null;if(M.unshift({identifier:G,previous:k,sender:x.userId,stateDelta:Z,time:{adjusted:Date.now()+t-b}}),M.length>B)M.splice(B);J({identifier:G,previous:k,stateDelta:Z,type:h6}),g()},y=()=>{if(x.previousState){let Z=k6(x.previousState,q);if(Z.length>0)h(Z)}},d=()=>{if(x.users.length>1)J({type:g6,state:A(q)})},g=()=>{x.previousState=A(q)};return Q.onMessage.addListener(({data:Z,time:G})=>{if(Z.sender===x.userId||Z.receiver&&Z.receiver!==x.userId)return;if(t=(t+G.delay)/2,b=(b+G.offset)/2,Z.type===g6){let k=0;for(;k<M.length;k++)if(M[k].time.adjusted>=G.adjusted)break;M.splice(0,k);for(let F in q)delete q[F];for(let F in Z.state)q[F]=Z.state[F];for(let F=0;F<M.length;F++)H6(q,M[F].stateDelta);g()}else if(Z.type===h6){let k=!0;for(let F=0;F<M.length;F++){let C=M[F];if(C.identifier===Z.previous||C.previous===Z.previous&&C.time.adjusted<G.adjusted){M.splice(F,0,{...Z,time:G}),k=!1;break}}if(k)M.unshift({...Z,time:G});for(let F=0;F<M.length;F++){let C=M[F];if(C.identifier===Z.identifier)break;d6(q,C.stateDelta)}for(let F=0;F<M.length;F++){let C=M[F];if(H6(q,C.stateDelta),C.identifier===Z.identifier)break}g()}}),Q.onConnection.addListener(({state:Z})=>{x.connectionState=Z}),Q.onRoomJoin.addListener(({creatorId:Z,roomCode:G,userId:k,users:F})=>{if(x.creatorId=Z,x.roomCode=G,x.userId=k,x.users=F,x.verifiedUsers=[],x.previousState=A(q),k===Z)x.verifiedUsers.push(k),a=setInterval(d,r)}),Q.onRoomLeave.addListener(()=>{for(let Z in x)delete x[Z];if(a)clearInterval(a)}),Q.onUserJoin.addListener(({userId:Z})=>{x.users.push(Z),B=Y+Y*x.users.length}),Q.onUserVerificationCode.addListener((Z)=>{if(Z.userId===x.creatorId)x.verificationCode=Z.code}),Q.onUserVerified.addListener(({userId:Z})=>{if(x.verifiedUsers.push(Z),B=Y+Y*x.users.length,x.userId===x.creatorId)d()}),Q.onUserLeave.addListener(({userId:Z})=>{for(let G=0;G<x.users.length;G++)if(x.users[G]===Z){x.users.splice(G,1);break}for(let G=0;G<x.verifiedUsers.length;G++)if(x.verifiedUsers[G]===Z){x.verifiedUsers.splice(G,1);break}B=Y+Y*x.users.length}),Object.assign({privateState:x,publicState:q,sendUpdate:y},Q)};J0(["roupn"],{createClientConnector:M6,createClientSynchronizer:C0});})();

//# debugId=054141625098FD3864756E2164756E21
