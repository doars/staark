(()=>{var br=Object.defineProperty,Tr=Object.defineProperties;var xr=Object.getOwnPropertyDescriptors;var rr=Object.getOwnPropertySymbols;var Or=Object.prototype.hasOwnProperty,wr=Object.prototype.propertyIsEnumerable;var tr=(t,e,r)=>e in t?br(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ne=(t,e)=>{for(var r in e||(e={}))Or.call(e,r)&&tr(t,r,e[r]);if(rr)for(var r of rr(e))wr.call(e,r)&&tr(t,r,e[r]);return t},se=(t,e)=>Tr(t,xr(e));var X=(t,e,r)=>new Promise((n,s)=>{var l=A=>{try{p(r.next(A))}catch(H){s(H)}},j=A=>{try{p(r.throw(A))}catch(H){s(H)}},p=A=>A.done?n(A.value):Promise.resolve(A.value).then(l,j);p((r=r.apply(t,e)).next())});var nr=(t,e)=>{let r=window;for(let n=0;n<t.length-1;n++)(typeof r[t[n]]!="object"||!Array.isArray(r[t[n]]))&&(r[t[n]]={}),r=r[t[n]];r[t[t.length-1]]=e};var Re="CONNECTED",Ie="CONNECTING",z="DISCONNECTED",Ne="DISCONNECTING",sr="PENDING_VERIFICATION";var Ee="_KA",Ce="_KO",Ae="_KT",or="_RC",ir="_RJ";var be="_SU",Te="_SS",cr="_UJ",ar="_UK",lr="_UL",xe="_UV";var Kr="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",Oe="ABCDEFGHKMNPQRSTUVWXYZ23456789",dr=(t=24,e=Kr)=>{let r="";for(let n=0;n<t;n++)r+=e.charAt(Math.floor(Math.random()*e.length));return r};var R=t=>{let e=atob(t);return Uint8Array.from(e,r=>r.charCodeAt(0)).buffer},ur=t=>{let e=atob(t),r=Uint8Array.from(e,n=>n.charCodeAt(0));return new TextDecoder().decode(r)},fr=t=>{let e=new TextEncoder().encode(t);if(e.length<65536)return btoa(String.fromCharCode(...e));let r="",n=65536;for(let s=0;s<e.length;s+=n){let l=e.subarray(s,s+n);r+=String.fromCharCode(...l)}return btoa(r)},I=t=>{let e=new Uint8Array(t);if(e.length<65536)return btoa(String.fromCharCode(...e));let r="",n=65536;for(let s=0;s<e.length;s+=n){let l=e.subarray(s,s+n);r+=String.fromCharCode(...l)}return btoa(r)};var v=()=>{let t=new Map;return{addListener:(e,r)=>{t.has(e)||t.set(e,r)},removeListener:e=>{t.delete(e)},dispatch:e=>{for(let[r,n]of t.entries())r(e),n&&n.once&&t.delete(r)}}};var yr="|",pr=":",Er=(t,e)=>{let r=[];for(let n in t){let s=t[n];s!=null&&r.push(n+pr+e(String(s)))}return r.join(yr)},mr=(t,e)=>{let r={},n=t.split(yr);for(let s of n){let l=s.indexOf(pr);if(l>0){let j=s.substring(0,l),p=s.substring(l+1);r[j]=e(p)}}return r};var _r=(t,e)=>{let r=Date.now();if(!t)return{delay:0,offset:0,adjusted:r};if(!e){let l=t-r;return{delay:0,offset:l,adjusted:r+l}}let n=r-e,s=(t-e+(t-r))/2;return{delay:n,offset:s,adjusted:r-n+s}};var oe="ECDH",we="P-256",ie="raw",Q="SHA-256",ce="spki",T="AES-GCM";var ae="RSA-OAEP",G="RSASSA-PKCS1-v1_5",hr="self.addEventListener('message',"+(()=>{Promise.all([crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["encrypt","decrypt"]),crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"])]).then(([t,e,r])=>{Promise.all([crypto.subtle.exportKey("spki",t.publicKey),crypto.subtle.exportKey("spki",e.publicKey)]).then(([n,s])=>{self.postMessage({success:!0,myEncryptKeys:t,mySignKeys:e,myExchangeKeys:r,myPublicEncryptKey:n,myPublicSignKey:s})}).catch(n=>{self.postMessage({success:!1,error:n.message})})}).catch(t=>{self.postMessage({success:!1,error:t.message})})}).toString()+")",gr="self.addEventListener('message',"+(()=>{crypto.subtle.generateKey({length:256,name:"AES-GCM"},!0,["encrypt","decrypt"]).then(t=>{self.postMessage({success:!0,sharedKey:t})}).catch(t=>{self.postMessage({success:!1,error:t.message})})}).toString()+")";var Ke="S",Rr="T",De="E",Se="I",Ue="U",Pe="D",Le="V",ve="K",He="P",Me="G";var me=(t={})=>{let{contentType:e="application/json",deserializeMessage:r=JSON.parse,serializeMessage:n=JSON.stringify,createRoomEndpoint:s="/create-room",joinRoomEndpoint:l="/join-room",httpUrl:j="http://localhost:3000",wsUrl:p="http://localhost:3000",messageBufferMaxCount:A=50,messageBufferMaxDuration:H=60*1e3}=t,b=z,m,S,O,U,M,i,f,y,d,C,Z,le,F,P=[],L,B=new Map,q=new Map,$=new Map,de=new Map,J=()=>(!S&&!M&&(M=new Promise((o,a)=>{let h=new Worker(URL.createObjectURL(new Blob([hr],{type:"text/javascript"})));h.addEventListener("message",u=>{if(u.data.success)i=u.data.myEncryptKeys,Z=u.data.mySignKeys,f=u.data.myExchangeKeys,d=u.data.myPublicEncryptKey,C=u.data.myPublicSignKey,S=!0,M=null,o();else{let _=new Error(u.data.error);N.dispatch({error:_}),a(_)}h.terminate()}),h.addEventListener("error",u=>{N.dispatch({error:u}),a(u),h.terminate()}),h.postMessage({type:"USER_KEYS"})})),M);J();let N=v(),Ge=v(),Fe=v(),Ve=v(),je=v(),Be=v(),ue=v(),Je=v(),Xe=v(),V=o=>{b!==o&&(b=o,Xe.dispatch({state:o}))},ze=o=>X(null,null,function*(){let a=B.get(o);a&&(de.set(o,Array.from(new Uint8Array(yield crypto.subtle.digest(Q,new TextEncoder().encode(le+I(yield crypto.subtle.exportKey("raw",a))))))),Je.dispatch({userId:o,code:ge(o)}))}),ee=()=>{b===z||b===Ne||(V(Ne),L&&L.close(),m=S=O=U=M=y=i=f=d=C=Z=F=P=L=null,B.clear(),q.clear(),$.clear(),de.clear(),J(),V(z))},We=o=>fe({type:ar,userId:o}),Qe=(o,a=null)=>{if(!a&&b&&b!==z)return;V(Ie),le=o;let h=new URL(p+l);h.searchParams.append("code",le),a&&h.searchParams.append("creator",a),L=new WebSocket(h.toString()),L.addEventListener("close",u=>{Ve.dispatch({event:u}),ee()}),L.addEventListener("error",u=>{N.dispatch({event:u}),ee()}),L.addEventListener("message",u=>X(null,null,function*(){Ze(mr(u.data,ur),u.data)}))},Ze=(o,a,h=!1)=>X(null,null,function*(){let{[Ke]:u,[Rr]:_,[Se]:g,[De]:w,[Pe]:K,[Le]:D,[ve]:re,[He]:qe,[Me]:$e,[Ue]:er}=o,c,te,ye;if(u?ye=u:K?ye=K:ye=a,w){if(!F||!h&&P.length>0){P.push({time:Date.now(),parts:o,raw:a}),P.length>A&&P.shift();return}if(!g){N.dispatch(new Error("Missing IV to decrypt message"));return}c=yield crypto.subtle.decrypt({iv:R(g),name:T},F,R(w)),c=new TextDecoder().decode(c)}else if(qe){if(!$e||!re||!D)return;S||(yield J());let E=r(new TextDecoder().decode(yield crypto.subtle.decrypt({iv:R(D),name:T},yield crypto.subtle.importKey("raw",yield crypto.subtle.decrypt({name:ae},i.privateKey,R(re)),{name:T},!0,["encrypt","decrypt"]),R(qe))));if(E.type===Ee)te=E;else{let k=E.sender;if(!k){N.dispatch({error:new Error("Message from unknown sender")});return}let Y=$.get(k);if(!Y){N.dispatch({error:new Error("No public key for "+k)});return}if(!(yield crypto.subtle.verify(G,Y,R($e),new TextEncoder().encode(E.payload)))){N.dispatch({error:new Error("Invalid signature from "+k)});return}te=E}}else c=ye;if(!te)try{te=r(c)}catch(E){N.dispatch({error:new Error("Failed to parse message "+a)});return}switch(c=te,c.type){case ir:if(m=c.creatorId,y=c.userId,Fe.dispatch({creatorId:c.creatorId,roomCode:le,userId:c.userId,users:c.users}),y===m)V(Re);else{V(sr),S||(yield J());let E=yield crypto.subtle.exportKey(ie,f.publicKey);W({type:Ce,publicData:typeof O=="function"?O():O,publicEncryptKey:I(d),publicExchangeKey:I(E),publicSignKey:I(C),signature:I(yield crypto.subtle.sign(G,Z.privateKey,E))},{allowUnencrypted:!0,receiver:m})}break;case Ce:if(y===m){let E=c.sender;if(U&&!U({data:c.publicData,userId:E})){We(E);return}q.set(E,yield crypto.subtle.importKey(ce,R(c.publicEncryptKey),{hash:Q,name:ae},!0,["encrypt"]));let k=yield crypto.subtle.importKey(ce,R(c.publicSignKey),{hash:Q,name:G},!0,["verify"]),Y=R(c.publicExchangeKey);if(!(yield crypto.subtle.verify(G,k,R(c.signature),Y))){N.dispatch({error:new Error("Invalid signature for exchange from "+E)});return}$.set(E,k),S||(yield J()),B.set(E,yield crypto.subtle.deriveKey({name:oe,public:yield crypto.subtle.importKey(ie,Y,{name:oe,namedCurve:we},!0,[])},f.privateKey,{length:256,name:T},!0,["encrypt","decrypt"]));let pe=yield crypto.subtle.exportKey(ie,f.publicKey);W({type:Ee,publicData:typeof O=="function"?O():O,publicEncryptKey:I(d),publicExchangeKey:I(pe),publicSignKey:I(C),signature:I(yield crypto.subtle.sign(G,Z.privateKey,pe))},{receiver:E}),ze(E)}break;case Ee:if(er===y&&c.sender===m){if(U&&!U({data:c.publicData,userId:m})){ee();return}let E=yield crypto.subtle.importKey(ce,R(c.publicSignKey),{hash:Q,name:G},!0,["verify"]);if(c.publicExchangeKey&&c.signature&&!(yield crypto.subtle.verify(G,E,R(c.signature),R(c.publicExchangeKey)))){N.dispatch({error:new Error("Invalid signature for exchange from "+m)}),ee();return}$.set(m,E),q.set(m,yield crypto.subtle.importKey(ce,R(c.publicEncryptKey),{hash:Q,name:ae},!0,["encrypt"])),S||(yield J()),B.set(m,yield crypto.subtle.deriveKey({name:oe,public:yield crypto.subtle.importKey(ie,R(c.publicExchangeKey),{name:oe,namedCurve:we},!0,[])},f.privateKey,{length:256,name:T},!0,["encrypt","decrypt"])),ze(m)}break;case Ae:if(er===y&&c.sender===m){let E=B.get(m);if(!E){N.dispatch({error:new Error("No derived key for host "+m)});return}if(F=yield crypto.subtle.importKey("raw",yield crypto.subtle.decrypt({iv:R(c.sharedKeyIv),name:T},E,R(c.sharedKey)),{name:T},!0,["encrypt","decrypt"]),ue.dispatch({userId:y}),P.length>0){let k=Date.now();for(P=P.filter(Y=>k-Y.time<H);P.length>0;){let{parts:Y,raw:pe}=P.shift();Ze(Y,pe,!0)}}V(Re)}break;case lr:Be.dispatch({userId:c.userId}),B.delete(c.userId),q.delete(c.userId),$.delete(c.userId);break;case cr:je.dispatch({userId:c.userId});break;case xe:ue.dispatch({userId:c.userId});break;default:Ge.dispatch({data:c,time:_r(_,c==null?void 0:c.senderTime)});break}}),W=(h,...u)=>X(null,[h,...u],function*(o,a={}){if(!L||L.readyState!==WebSocket.OPEN)return N.dispatch({error:new Error("No open socket")}),!1;let _=n(se(ne({},o),{sender:y,senderTime:Date.now()})),g={};if(a.receiver){let w=q.get(a.receiver);if(w){let K=yield crypto.subtle.generateKey({name:T,length:256},!0,["encrypt","decrypt"]),D=crypto.getRandomValues(new Uint8Array(12)),re=yield crypto.subtle.encrypt({iv:D,name:T},K,new TextEncoder().encode(_));S||(yield J()),g[Me]=I(yield crypto.subtle.sign(G,Z.privateKey,re)),g[ve]=I(yield crypto.subtle.encrypt({name:ae},w,yield crypto.subtle.exportKey("raw",K))),g[He]=I(re),g[Le]=I(D)}else if(a.allowUnencrypted)g[Pe]=_;else return N.dispatch({error:new Error("No public key for "+a.receiver)}),!1;g[Ue]=a.receiver}else if(a.server)g[Ke]=_;else if(F){let w=crypto.getRandomValues(new Uint8Array(12));g[Se]=I(w),g[De]=I(yield crypto.subtle.encrypt({iv:w,name:T},F,new TextEncoder().encode(_)))}else return N.dispatch(new Error("Trying to send without valid destination")),!1;return L.send(Er(g,fr)),!0}),fe=o=>y&&y===m&&W(o,{server:!0}),Ar=(o,a)=>a&&W(o,{receiver:a}),ge=(o,a=6)=>{if(!de.has(o))return!1;let h=de.get(o),u="";for(let _=0;_<a;_++){let g=h[_]%Oe.length;u+=Oe[g]}return u};return{onConnection:Xe,onError:N,onMessage:Ge,onRoomJoin:Fe,onRoomLeave:Ve,onUserJoin:je,onUserLeave:Be,onUserVerified:ue,onUserVerificationCode:Je,messageRoom:o=>W(o),messageServer:fe,messageUser:Ar,closeRoom:()=>fe({type:or}),createRoom:(...a)=>X(null,[...a],function*(o={}){if(b&&b!==z)return;V(Ie),o.publicData&&(O=o.publicData),o.verifyPublicData&&(U=o.verifyPublicData);try{yield new Promise((g,w)=>{let K=new Worker(URL.createObjectURL(new Blob([gr],{type:"text/javascript"})));K.addEventListener("message",D=>{D.data.success?(F=D.data.sharedKey,g()):w(new Error(D.data.error)),K.terminate()}),K.addEventListener("error",D=>{w(D),K.terminate()}),K.postMessage({type:"SHARED_KEY"})})}catch(g){V(z),N.dispatch({error:g});return}let h=new URL(j+s);o.limit&&h.searchParams.append("limit",o.limit);let u=yield fetch(h.toString(),{method:"GET",headers:{Accept:e}});if(!u.ok)throw new Error("Failed to create room");let _=yield u.text();return _=r(_),y=_.userId,Qe(_.roomCode,_.creatorSecret),_}),joinRoom:(o,a={})=>{a.publicData&&(O=a.publicData),a.verifyPublicData&&(U=a.verifyPublicData),Qe(o)},leaveRoom:ee,kickUser:We,getVerificationCode:ge,verifyUser:(o,a)=>X(null,null,function*(){if(y!==m||!a)return!1;let h=ge(o,a.length);if(!h||!a||h!==a)return!1;let u=B.get(o);if(!u)return!1;let _=crypto.getRandomValues(new Uint8Array(12));return W({type:Ae,sharedKey:I(yield crypto.subtle.encrypt({iv:_,name:T},u,yield crypto.subtle.exportKey("raw",F))),sharedKeyIv:I(_)},{receiver:o}),ue.dispatch({userId:o}),fe({type:xe,userId:o}),!0})}};var x=t=>{if(typeof t=="object"){let e=Array.isArray(t)?[]:{};for(let r in t)e[r]=x(t[r]);return e}return t};var ke=(t,e,r)=>{let n=t;for(let s=0;s<e.length-1;s++){let l=e[s];l in n||(n[l]={}),n=n[l]}n[e[e.length-1]]=x(r)},Nr=(t,e)=>{let r=t;for(let n=0;n<e.length-1;n++)if(r=r[e[n]],!r)return;Array.isArray(r)?r.splice(parseInt(e[e.length-1]),1):delete r[e[e.length-1]]},_e=(t,e,r=[])=>{let n=[];for(let s in t){let l=[...r,s];s in e?typeof t[s]=="object"&&typeof e[s]=="object"?n.unshift(..._e(t[s],e[s],l)):t[s]!==e[s]&&n.unshift({type:"set",path:l,old:x(t[s]),new:x(e[s])}):n.unshift({type:"delete",path:l,old:x(t[s])})}for(let s in e)s in t||n.unshift({type:"set",path:[...r,s],new:x(e[s])});return n},he=(t,e)=>{for(let r of e)r.type==="set"?ke(t,r.path,r.new):r.type==="delete"&&Nr(t,r.path);return t},Ye=(t,e)=>{for(let r of e)r.type==="set"?r.old===void 0?Nr(t,r.path):ke(t,r.path,r.old):r.type==="delete"&&ke(t,r.path,r.old);return t};var Cr=(t={},e={},r={})=>{let n=me(t),{messageRoom:s}=n,{windowPerUser:l=16,synchronisationInterval:j=60*1e3}=t,p=[],A,H=0,b=0,m=l,S=i=>{let f=dr(),y=i.length>0?i[0].identifier:null;p.unshift({identifier:f,previous:y,sender:e.userId,stateDelta:i,time:{adjusted:Date.now()+H-b}}),p.length>m&&p.splice(m),s({identifier:f,previous:y,stateDelta:i,type:be}),M()},O=()=>{if(e.previousState){let i=_e(e.previousState,r);i.length>0&&S(i)}},U=()=>{e.users.length>1&&s({type:Te,state:x(r)})},M=()=>{e.previousState=x(r)};return n.onMessage.addListener(({data:i,time:f})=>{if(!(i.sender===e.userId||i.receiver&&i.receiver!==e.userId)){if(H=(H+f.delay)/2,b=(b+f.offset)/2,i.type===Te){let y=0;for(;y<p.length&&!(p[y].time.adjusted>=f.adjusted);y++);p.splice(0,y);for(let d in r)delete r[d];for(let d in i.state)r[d]=i.state[d];for(let d=0;d<p.length;d++)he(r,p[d].stateDelta);M()}else if(i.type===be){let y=!0;for(let d=0;d<p.length;d++){let C=p[d];if(C.identifier===i.previous||C.previous===i.previous&&C.time.adjusted<f.adjusted){p.splice(d,0,se(ne({},i),{time:f})),y=!1;break}}y&&p.unshift(se(ne({},i),{time:f}));for(let d=0;d<p.length;d++){let C=p[d];if(C.identifier===i.identifier)break;Ye(r,C.stateDelta)}for(let d=0;d<p.length;d++){let C=p[d];if(he(r,C.stateDelta),C.identifier===i.identifier)break}M()}}}),n.onConnection.addListener(({state:i})=>{e.connectionState=i}),n.onRoomJoin.addListener(({creatorId:i,roomCode:f,userId:y,users:d})=>{e.creatorId=i,e.roomCode=f,e.userId=y,e.users=d,e.verifiedUsers=[],e.previousState=x(r),y===i&&(e.verifiedUsers.push(y),A=setInterval(U,j))}),n.onRoomLeave.addListener(()=>{for(let i in e)delete e[i];A&&clearInterval(A)}),n.onUserJoin.addListener(({userId:i})=>{e.users.push(i),m=l+l*e.users.length}),n.onUserVerificationCode.addListener(i=>{i.userId===e.creatorId&&(e.verificationCode=i.code)}),n.onUserVerified.addListener(({userId:i})=>{e.verifiedUsers.push(i),m=l+l*e.users.length,e.userId===e.creatorId&&U()}),n.onUserLeave.addListener(({userId:i})=>{for(let f=0;f<e.users.length;f++)if(e.users[f]===i){e.users.splice(f,1);break}for(let f=0;f<e.verifiedUsers.length;f++)if(e.verifiedUsers[f]===i){e.verifiedUsers.splice(f,1);break}m=l+l*e.users.length}),Object.assign({privateState:e,publicState:r,sendUpdate:O},n)};nr(["roupn"],{createClientConnector:me,createClientSynchronizer:Cr});})();
